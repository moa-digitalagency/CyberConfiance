{% extends "admin/base.html" %}

{% block title %}Request #{{ submission.id }} - Admin{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="{{ url_for('admin_requests.requests_dashboard') }}" style="color: var(--accent-blue); text-decoration: none;">← Back to Requests</a>
</div>

<h1 style="font-size: 2rem; margin-bottom: 1rem;">Request #{{ submission.id }}</h1>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start;">
    <div>
        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem; color: var(--accent-blue);">Request Details</h3>
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-primary);">Type:</strong>
                <span style="color: var(--text-secondary);"> {{ submission.request_type }}</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-primary);">Description:</strong>
                <p style="color: var(--text-secondary); margin-top: 0.5rem; line-height: 1.6;">{{ submission.description }}</p>
            </div>
            {% if submission.urls %}
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-primary);">URLs:</strong>
                <pre style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 6px; margin-top: 0.5rem; color: var(--text-secondary); overflow-x: auto;">{{ submission.urls }}</pre>
            </div>
            {% endif %}
            {% if submission.file_name %}
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-primary);">File:</strong>
                <span style="color: var(--text-secondary);"> {{ submission.file_name }} ({{ (submission.file_size / 1024) | round(2) }} KB)</span>
                <br>
                <strong style="color: var(--text-primary);">Hash:</strong>
                <code style="color: var(--text-secondary); font-size: 0.9rem;">{{ submission.file_hash }}</code>
            </div>
            {% endif %}
        </div>
        
        {% if submission.threat_detected %}
        <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.5); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem; color: #ef4444;">⚠️ ALERTE : Menace Détectée</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Cette soumission contient du contenu malveillant qui a été détecté et bloqué par l'analyse de sécurité.</p>
            
            {% if submission.vt_file_results %}
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                <strong style="color: #ef4444;">Type de menace identifiée :</strong>
                <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                    {% if submission.vt_file_results.data %}
                        {% if submission.vt_file_results.data.attributes %}
                            {% if submission.vt_file_results.data.attributes.last_analysis_stats %}
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                                    <div><strong>Malicieux:</strong> {{ submission.vt_file_results.data.attributes.last_analysis_stats.malicious or 0 }}</div>
                                    <div><strong>Suspects:</strong> {{ submission.vt_file_results.data.attributes.last_analysis_stats.suspicious or 0 }}</div>
                                    <div><strong>Non détecté:</strong> {{ submission.vt_file_results.data.attributes.last_analysis_stats.undetected or 0 }}</div>
                                    <div><strong>Inoffensif:</strong> {{ submission.vt_file_results.data.attributes.last_analysis_stats.harmless or 0 }}</div>
                                </div>
                            {% endif %}
                            {% if submission.vt_file_results.data.attributes.popular_threat_classification %}
                                <div style="margin-top: 1rem;">
                                    <strong>Classification :</strong> 
                                    <span style="color: #ef4444;">{{ submission.vt_file_results.data.attributes.popular_threat_classification.suggested_threat_label }}</span>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1.5rem;">
            <h3 style="margin-bottom: 1rem; color: var(--accent-blue);">Résultats de l'Analyse de Sécurité</h3>
            
            {% if submission.vt_text_results %}
            <div style="margin-bottom: 1.5rem;">
                <strong style="color: var(--text-primary);">Text Analysis:</strong>
                <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 6px; margin-top: 0.5rem;">
                    {% if submission.vt_text_results.error == false %}
                        <div style="color: var(--text-secondary);">
                            {% if submission.vt_text_results.malicious_patterns %}
                                <div style="margin-bottom: 0.5rem;">
                                    <strong style="color: #ef4444;">Patterns malveillants détectés:</strong>
                                    <span style="color: #ef4444;"> {{ submission.vt_text_results.malicious_patterns|length }}</span>
                                </div>
                            {% endif %}
                            {% if submission.vt_text_results.malicious_urls %}
                                <div style="margin-bottom: 0.5rem;">
                                    <strong style="color: #ef4444;">URLs malveillantes détectées:</strong>
                                    <span style="color: #ef4444;"> {{ submission.vt_text_results.malicious_urls|length }}</span>
                                </div>
                            {% endif %}
                            {% if submission.vt_text_results.message %}
                                <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                                    {{ submission.vt_text_results.message }}
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div style="color: var(--text-secondary);">
                            <strong>Résultat:</strong> {{ submission.vt_text_results.message or "Analyse terminée" }}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% if submission.vt_url_results %}
            <div style="margin-bottom: 1.5rem;">
                <strong style="color: var(--text-primary);">URL Scans:</strong>
                <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 6px; margin-top: 0.5rem;">
                    {% if submission.vt_url_results is iterable and submission.vt_url_results is not string %}
                        {% for url_result in submission.vt_url_results %}
                            {% if url_result.error == false %}
                                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    {% if url_result.found == false %}
                                        <div style="color: var(--text-secondary);">
                                            <strong>Menace:</strong> <span style="color: #10b981;">Aucune menace connue détectée</span>
                                        </div>
                                        <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                                            {{ url_result.message }}
                                        </div>
                                    {% else %}
                                        <div style="color: #ef4444;">
                                            <strong>⚠️ Menace détectée!</strong>
                                        </div>
                                        <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                                            {{ url_result.message }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div style="color: var(--text-secondary);">
                            Analyse des URLs terminée
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% if submission.vt_file_results %}
            <div>
                <strong style="color: var(--text-primary);">File Scan:</strong>
                <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 6px; margin-top: 0.5rem;">
                    {% if submission.vt_file_results.data and submission.vt_file_results.data.attributes %}
                        {% set attrs = submission.vt_file_results.data.attributes %}
                        {% if attrs.last_analysis_stats %}
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                                <div style="color: var(--text-secondary);">
                                    <strong>Malicieux:</strong> <span style="color: #ef4444;">{{ attrs.last_analysis_stats.malicious or 0 }}</span>
                                </div>
                                <div style="color: var(--text-secondary);">
                                    <strong>Suspects:</strong> <span style="color: #f59e0b;">{{ attrs.last_analysis_stats.suspicious or 0 }}</span>
                                </div>
                                <div style="color: var(--text-secondary);">
                                    <strong>Inoffensif:</strong> <span style="color: #10b981;">{{ attrs.last_analysis_stats.harmless or 0 }}</span>
                                </div>
                                <div style="color: var(--text-secondary);">
                                    <strong>Non détecté:</strong> {{ attrs.last_analysis_stats.undetected or 0 }}
                                </div>
                            </div>
                        {% endif %}
                        {% if attrs.type_description %}
                            <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                                <strong>Type de fichier:</strong> {{ attrs.type_description }}
                            </div>
                        {% endif %}
                    {% else %}
                        <div style="color: var(--text-secondary);">
                            Analyse du fichier terminée
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% if not submission.vt_text_results and not submission.vt_url_results and not submission.vt_file_results %}
                <p style="color: var(--text-secondary); font-style: italic;">Aucune analyse de sécurité disponible pour cette demande.</p>
            {% endif %}
        </div>
    </div>
    
    <div>
        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem; color: var(--accent-blue);">Submission Info</h3>
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-primary);">Status:</strong>
                <span style="color: var(--text-secondary);"> {{ submission.status }}</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-primary);">Submitted:</strong>
                <span style="color: var(--text-secondary);"> {{ submission.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-primary);">IP Address:</strong>
                <span style="color: var(--text-secondary);"> {{ submission.ip_address }}</span>
            </div>
        </div>
        
        {% if not submission.is_anonymous %}
        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem; color: var(--accent-blue);">Contact Information</h3>
            {% if submission.contact_name %}
            <div style="margin-bottom: 0.5rem;">
                <strong style="color: var(--text-primary);">Name:</strong>
                <span style="color: var(--text-secondary);"> {{ submission.contact_name }}</span>
            </div>
            {% endif %}
            {% if submission.contact_email %}
            <div style="margin-bottom: 0.5rem;">
                <strong style="color: var(--text-primary);">Email:</strong>
                <span style="color: var(--text-secondary);"> {{ submission.contact_email }}</span>
            </div>
            {% endif %}
            {% if submission.contact_phone %}
            <div style="margin-bottom: 0.5rem;">
                <strong style="color: var(--text-primary);">Phone:</strong>
                <span style="color: var(--text-secondary);"> {{ submission.contact_phone }}</span>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <p style="color: var(--text-secondary); margin: 0;"><em>This request was submitted anonymously.</em></p>
        </div>
        {% endif %}
        
        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1.5rem;">
            <h3 style="margin-bottom: 1rem; color: var(--accent-blue);">Update Status</h3>
            <form method="POST" action="{{ url_for('admin_requests.update_status', submission_id=submission.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">Status:</label>
                    <select name="status" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text-primary);">
                        <option value="pending" {% if submission.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="in-progress" {% if submission.status == 'in-progress' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if submission.status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="rejected" {% if submission.status == 'rejected' %}selected{% endif %}>Rejected</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary);">Admin Notes:</label>
                    <textarea name="admin_notes" rows="4" style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text-primary); font-family: inherit;">{{ submission.admin_notes or '' }}</textarea>
                </div>
                <button type="submit" style="width: 100%; padding: 0.75rem; background: rgba(59, 130, 246, 0.8); border: none; border-radius: 6px; color: white; font-weight: 500; cursor: pointer;">
                    Update Status
                </button>
            </form>
        </div>
    </div>
</div>

{% if submission.document_code %}
<div style="margin-top: 2rem; padding: 1.5rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 2rem; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <h4 style="margin-bottom: 0.5rem; color: var(--accent-blue);">Code du Document</h4>
            <p style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); margin: 0; font-family: monospace; letter-spacing: 2px;">
                {{ submission.document_code }}
            </p>
            <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                Type: {{ submission.request_type }}
            </p>
        </div>
        <div style="flex: 0; min-width: 150px;">
            <div style="background: white; padding: 1rem; border-radius: 8px; display: inline-block;">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{ request.host_url }}{% if submission.request_type == 'cybercrime-report' %}outils/analyse-fuites{% elif submission.request_type == 'fact-checking' or submission.request_type == 'osint' %}outils/quiz{% else %}outils/analyseur-securite{% endif %}?code={{ submission.document_code }}" 
                     alt="QR Code" 
                     style="display: block; width: 150px; height: 150px;" />
            </div>
            <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                Scan pour accéder à la page
            </p>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
