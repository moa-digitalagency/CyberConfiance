<!--
  CyberConfiance
  By MOA Digital Agency LLC
  Developed by: Aisance KALONJI
  Contact: moa@myoneart.com
  www.myoneart.com
-->
{% extends "admin/base.html" %}

{% block title %}Gestion des articles - Administration{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Gestion des articles</h1>
    <p>Liste et gestion des articles de blog</p>
</div>

<div class="admin-toolbar">
    <div class="toolbar-left">
        <div class="filter-group">
            <label for="search-input">Recherche:</label>
            <input type="text" id="search-input" placeholder="Titre, contenu..." style="min-width: 250px;">
        </div>
        <div class="filter-group">
            <label for="category-filter">Catégorie:</label>
            <select id="category-filter" onchange="updateFilters()">
                <option value="">Toutes</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="source-filter">Source:</label>
            <select id="source-filter" onchange="updateFilters()">
                <option value="">Toutes</option>
                {% for src in sources %}
                <option value="{{ src }}" {% if selected_source == src %}selected{% endif %}>{{ src }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="toolbar-right">
        <a href="{{ url_for('admin_panel.news_new') }}" class="btn btn-primary">+ Nouvel article</a>
    </div>
</div>

<div class="admin-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0;">Articles ({{ articles.total }})</h3>
    </div>
    
    <div class="table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Titre</th>
                    <th style="width: 120px;">Catégorie</th>
                    <th style="width: 150px;">Source</th>
                    <th style="width: 120px;">Publication</th>
                    <th style="width: 140px;">Créé le</th>
                    <th class="actions-cell" style="width: 200px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for article in articles.items %}
                <tr>
                    <td>
                        <strong style="color: var(--text-primary);">{{ article.title }}</strong>
                        {% if article.description %}
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ article.description }}
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-info">{{ article.category }}</span>
                    </td>
                    <td style="font-size: 0.85rem;">{{ article.source or 'N/A' }}</td>
                    <td style="font-size: 0.85rem;">
                        {{ article.published_date.strftime('%d/%m/%Y') if article.published_date else 'N/A' }}
                    </td>
                    <td style="font-size: 0.85rem;">{{ article.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="actions-cell">
                        <div class="action-btn-group">
                            <a href="{{ url_for('admin_panel.news_edit', id=article.id) }}" class="btn btn-primary btn-sm">Modifier</a>
                            <form method="POST" action="{{ url_for('admin_panel.news_delete', id=article.id) }}" style="display: inline;" onsubmit="return confirm('Supprimer cet article ?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if articles.pages > 1 %}
    <div class="pagination">
        {% if articles.has_prev %}
        <a href="?page={{ articles.prev_num }}{% if selected_category %}&category={{ selected_category|urlencode }}{% endif %}{% if selected_source %}&source={{ selected_source|urlencode }}{% endif %}">‹ Précédent</a>
        {% endif %}
        
        {% for page_num in articles.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
                {% if page_num == articles.page %}
                    <span class="active">{{ page_num }}</span>
                {% else %}
                    <a href="?page={{ page_num }}{% if selected_category %}&category={{ selected_category|urlencode }}{% endif %}{% if selected_source %}&source={{ selected_source|urlencode }}{% endif %}">{{ page_num }}</a>
                {% endif %}
            {% else %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if articles.has_next %}
        <a href="?page={{ articles.next_num }}{% if selected_category %}&category={{ selected_category|urlencode }}{% endif %}{% if selected_source %}&source={{ selected_source|urlencode }}{% endif %}">Suivant ›</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function updateFilters() {
    const category = document.getElementById('category-filter').value;
    const source = document.getElementById('source-filter').value;
    let url = '?';
    if (category) url += 'category=' + encodeURIComponent(category) + '&';
    if (source) url += 'source=' + encodeURIComponent(source);
    window.location.href = url;
}

// Search functionality
document.getElementById('search-input').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.admin-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %}
