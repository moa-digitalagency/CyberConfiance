{% extends "admin/base.html" %}

{% block title %}Détails Analyse Sécurité #{{ analysis.id }} - Administration{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Détails de l'Analyse de Sécurité #{{ analysis.id }}</h1>
    <p>Résultat complet de l'analyse</p>
</div>

<div class="admin-card">
    <h3>Informations générales</h3>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-top: 1rem;">
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Type d'entrée:</strong>
            <span class="badge badge-info">{{ analysis.input_type }}</span>
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Menace détectée:</strong>
            {% if analysis.threat_detected %}
            <span class="badge badge-danger" style="font-size: 1.1rem; padding: 0.5rem 1rem;">OUI</span>
            {% else %}
            <span class="badge badge-success" style="font-size: 1.1rem; padding: 0.5rem 1rem;">NON</span>
            {% endif %}
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Valeur analysée:</strong>
            <span style="color: var(--text-primary); word-break: break-all;">{{ analysis.input_value }}</span>
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Niveau de menace:</strong>
            {% if analysis.threat_level %}
            <span class="badge badge-warning">{{ analysis.threat_level }}</span>
            {% else %}
            <span class="badge badge-info">Aucun</span>
            {% endif %}
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Détections malveillantes:</strong>
            <span style="color: var(--text-primary);">{{ analysis.malicious_count }} / {{ analysis.total_engines }}</span>
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Date d'analyse:</strong>
            <span style="color: var(--text-primary);">{{ analysis.created_at.strftime('%d/%m/%Y %H:%M:%S') }}</span>
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Adresse IP:</strong>
            <span style="color: var(--text-primary);">{{ analysis.ip_address }}</span>
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">User Agent:</strong>
            <span style="color: var(--text-primary); font-size: 0.85rem; word-break: break-all;">{{ analysis.user_agent }}</span>
        </div>
    </div>
</div>

{% if analysis.analysis_results %}
<div class="admin-card">
    <h3>Résultats détaillés de l'analyse</h3>
    
    {% set results = analysis.analysis_results %}
    
    {% if results is mapping %}
        {% set scan_data = results.get('scans') or results.get('engines') or results.get('results') or results.get('engine_results') %}
        {% if scan_data %}
        <div style="margin-top: 1rem;">
            <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">Résultats des moteurs de détection</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                {% if scan_data is mapping %}
                    {% for engine_name, engine_result in scan_data.items() %}
                    {% if engine_result is mapping %}
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; border-left: 3px solid {% if engine_result.get('detected') or engine_result.get('category') == 'malicious' %}var(--accent-red){% elif engine_result.get('category') == 'suspicious' %}var(--accent-yellow){% else %}var(--accent-green){% endif %};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: var(--text-primary);">{{ engine_name }}</strong>
                            {% if engine_result.get('detected') or engine_result.get('category') == 'malicious' %}
                            <span class="badge badge-danger">Détecté</span>
                            {% elif engine_result.get('category') == 'suspicious' %}
                            <span class="badge badge-warning">Suspect</span>
                            {% else %}
                            <span class="badge badge-success">Sain</span>
                            {% endif %}
                        </div>
                        {% if engine_result.get('result') %}
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            Résultat: <span style="color: var(--accent-red);">{{ engine_result.result }}</span>
                        </div>
                        {% endif %}
                        {% if engine_result.get('engine_version') %}
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Version: {{ engine_result.engine_version }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                {% elif scan_data is iterable and scan_data is not string %}
                    {% for engine_result in scan_data %}
                    {% if engine_result is mapping %}
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; border-left: 3px solid {% if engine_result.get('detected') or engine_result.get('category') == 'malicious' %}var(--accent-red){% elif engine_result.get('category') == 'suspicious' %}var(--accent-yellow){% else %}var(--accent-green){% endif %};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: var(--text-primary);">{{ engine_result.get('engine_name') or engine_result.get('name') or 'Moteur' }}</strong>
                            {% if engine_result.get('detected') or engine_result.get('category') == 'malicious' %}
                            <span class="badge badge-danger">Détecté</span>
                            {% elif engine_result.get('category') == 'suspicious' %}
                            <span class="badge badge-warning">Suspect</span>
                            {% else %}
                            <span class="badge badge-success">Sain</span>
                            {% endif %}
                        </div>
                        {% if engine_result.get('result') %}
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            Résultat: <span style="color: var(--accent-red);">{{ engine_result.result }}</span>
                        </div>
                        {% endif %}
                        {% if engine_result.get('engine_version') %}
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Version: {{ engine_result.engine_version }}
                        </div>
                        {% endif %}
                    </div>
                    {% elif engine_result is string %}
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent-green);">
                        <strong style="color: var(--text-primary);">{{ engine_result }}</strong>
                        <span class="badge badge-success" style="margin-left: 0.5rem;">Sain</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% if results.get('stats') or results.get('statistics') %}
        <div style="margin-top: 1.5rem;">
            <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">Statistiques</h4>
            {% set stats = results.get('stats') or results.get('statistics') %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                {% if stats.malicious is defined %}
                <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-red);">{{ stats.malicious }}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Malveillant</div>
                </div>
                {% endif %}
                {% if stats.suspicious is defined %}
                <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-yellow);">{{ stats.suspicious }}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Suspect</div>
                </div>
                {% endif %}
                {% if stats.harmless is defined or stats.clean is defined %}
                <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-green);">{{ stats.harmless or stats.clean }}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Sain</div>
                </div>
                {% endif %}
                {% if stats.undetected is defined %}
                <div style="background: rgba(156, 163, 175, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-secondary);">{{ stats.undetected }}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Non détecté</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% if results.get('permalink') or results.get('scan_id') or results.get('resource') %}
        <div style="margin-top: 1.5rem;">
            <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">Informations de l'analyse</h4>
            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                {% if results.get('scan_id') %}
                <div style="margin-bottom: 0.5rem;">
                    <strong style="color: var(--text-secondary);">ID d'analyse:</strong>
                    <span style="color: var(--text-primary); font-family: monospace;">{{ results.scan_id }}</span>
                </div>
                {% endif %}
                {% if results.get('resource') %}
                <div style="margin-bottom: 0.5rem;">
                    <strong style="color: var(--text-secondary);">Ressource:</strong>
                    <span style="color: var(--text-primary); word-break: break-all;">{{ results.resource }}</span>
                </div>
                {% endif %}
                {% if results.get('permalink') %}
                <div>
                    <strong style="color: var(--text-secondary);">Lien VirusTotal:</strong>
                    <a href="{{ results.permalink }}" target="_blank" style="color: var(--accent-blue);">Voir sur VirusTotal</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% if not (results.get('scans') or results.get('engines') or results.get('results') or results.get('engine_results') or results.get('stats')) %}
        <div style="margin-top: 1rem;">
            {% for key, value in results.items() %}
            {% if key not in ['scans', 'engines', 'results', 'engine_results', 'stats', 'statistics', 'permalink', 'scan_id', 'resource', 'error', 'success'] %}
            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                <strong style="color: var(--accent-blue);">{{ key|replace('_', ' ')|title }}:</strong>
                {% if value is mapping %}
                <div style="margin-top: 0.5rem; padding-left: 1rem;">
                    {% for sub_key, sub_value in value.items() %}
                    <div style="margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary);">{{ sub_key|replace('_', ' ')|title }}:</span>
                        {% if sub_value is sameas true %}
                        <span class="badge badge-success" style="margin-left: 0.5rem;">Oui</span>
                        {% elif sub_value is sameas false %}
                        <span class="badge badge-secondary" style="margin-left: 0.5rem;">Non</span>
                        {% elif sub_value is number %}
                        <span style="color: var(--accent-blue); margin-left: 0.5rem; font-weight: 600;">{{ sub_value }}</span>
                        {% else %}
                        <span style="color: var(--text-primary); margin-left: 0.5rem;">{{ sub_value }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% elif value is iterable and value is not string %}
                <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    {% for item in value %}
                    {% if item is mapping %}
                    <div style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 6px; min-width: 200px;">
                        {% for item_key, item_value in item.items() %}
                        <div style="margin-bottom: 0.25rem;">
                            <span style="color: var(--text-secondary); font-size: 0.8rem;">{{ item_key|replace('_', ' ')|title }}:</span>
                            <span style="color: var(--text-primary); font-size: 0.85rem; margin-left: 0.25rem;">{{ item_value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <span class="badge badge-info">{{ item }}</span>
                    {% endif %}
                    {% endfor %}
                </div>
                {% elif value is sameas true %}
                <span class="badge badge-success" style="margin-left: 0.5rem;">Oui</span>
                {% elif value is sameas false %}
                <span class="badge badge-secondary" style="margin-left: 0.5rem;">Non</span>
                {% elif value is number %}
                <span style="color: var(--accent-blue); margin-left: 0.5rem; font-weight: 600;">{{ value }}</span>
                {% else %}
                <span style="color: var(--text-primary); margin-left: 0.5rem;">{{ value }}</span>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    {% else %}
    <div style="margin-top: 1rem;">
        <div class="results-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            {% if analysis.analysis_results.malicious is defined %}
            <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-red);">{{ analysis.analysis_results.malicious }}</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">Malveillant</div>
            </div>
            {% endif %}
            {% if analysis.analysis_results.suspicious is defined %}
            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-yellow);">{{ analysis.analysis_results.suspicious }}</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">Suspect</div>
            </div>
            {% endif %}
            {% if analysis.analysis_results.clean is defined or analysis.analysis_results.harmless is defined %}
            <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-green);">{{ analysis.analysis_results.clean or analysis.analysis_results.harmless or 0 }}</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">Sain</div>
            </div>
            {% endif %}
            {% if analysis.analysis_results.total is defined %}
            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-blue);">{{ analysis.analysis_results.total }}</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">Total Moteurs</div>
            </div>
            {% endif %}
        </div>
        
        {% if analysis.analysis_results.threat_detected is defined %}
        <div style="background: {% if analysis.analysis_results.threat_detected %}rgba(239, 68, 68, 0.1){% else %}rgba(34, 197, 94, 0.1){% endif %}; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <strong style="color: {% if analysis.analysis_results.threat_detected %}var(--accent-red){% else %}var(--accent-green){% endif %};">
                {% if analysis.analysis_results.threat_detected %}Menace Detectee{% else %}Aucune Menace Detectee{% endif %}
            </strong>
            {% if analysis.analysis_results.message %}
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">{{ analysis.analysis_results.message }}</p>
            {% endif %}
        </div>
        {% endif %}
        
        {% if analysis.analysis_results.found is sameas false %}
        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent-blue);">
            <strong style="color: var(--accent-blue);">Element non repertorie</strong>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">{{ analysis.analysis_results.message or 'Cet element n est pas connu dans notre base de donnees.' }}</p>
        </div>
        {% endif %}
        
        {% for key, value in analysis.analysis_results.items() %}
        {% if key not in ['malicious', 'suspicious', 'clean', 'harmless', 'total', 'threat_detected', 'threat_level', 'message', 'found', 'error', 'success', 'type'] %}
        <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
            <strong style="color: var(--accent-blue);">{{ key|replace('_', ' ')|title }}:</strong>
            {% if value is sameas true %}
            <span class="badge badge-success" style="margin-left: 0.5rem;">Oui</span>
            {% elif value is sameas false %}
            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Non</span>
            {% elif value is number %}
            <span style="color: var(--accent-blue); margin-left: 0.5rem; font-weight: 600;">{{ value }}</span>
            {% elif value is string %}
            <span style="color: var(--text-primary); margin-left: 0.5rem;">{{ value }}</span>
            {% elif value is iterable %}
            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {% for item in value %}
                <span class="badge badge-info">{{ item }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

<div style="margin-top: 2rem;">
    <a href="{{ url_for('admin_panel.security_history') }}" class="btn btn-secondary">Retour à l'historique</a>
</div>
{% endblock %}
