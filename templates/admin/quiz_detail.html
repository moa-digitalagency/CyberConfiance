{% extends "admin/base.html" %}

{% block title %}Détails Quiz #{{ quiz.id }} - Administration{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Détails du Quiz #{{ quiz.id }}</h1>
    <p>Résultat complet du quiz</p>
</div>

<div class="admin-card">
    <h3>Informations générales</h3>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-top: 1rem;">
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Email:</strong>
            <span style="color: var(--text-primary);">{{ quiz.email }}</span>
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Score global:</strong>
            {% if quiz.overall_score >= 80 %}
            <span class="badge badge-success" style="font-size: 1.2rem; padding: 0.5rem 1rem;">{{ quiz.overall_score }}%</span>
            {% elif quiz.overall_score >= 60 %}
            <span class="badge badge-warning" style="font-size: 1.2rem; padding: 0.5rem 1rem;">{{ quiz.overall_score }}%</span>
            {% else %}
            <span class="badge badge-danger" style="font-size: 1.2rem; padding: 0.5rem 1rem;">{{ quiz.overall_score }}%</span>
            {% endif %}
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Date:</strong>
            <span style="color: var(--text-primary);">{{ quiz.created_at.strftime('%d/%m/%Y %H:%M:%S') }}</span>
        </div>
        <div>
            <strong style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Adresse IP:</strong>
            <span style="color: var(--text-primary);">{{ quiz.ip_address }}</span>
        </div>
    </div>
</div>

<div class="admin-card">
    <h3>Scores par catégorie</h3>
    <table class="admin-table">
        <thead>
            <tr>
                <th>Catégorie</th>
                <th>Score</th>
            </tr>
        </thead>
        <tbody>
            {% if quiz.category_scores and quiz.category_scores.get('percentages') %}
                {% for category, score in quiz.category_scores.get('percentages', {}).items() %}
                <tr>
                    <td>{{ category.capitalize() }}</td>
                    <td>
                        {% if score >= 80 %}
                        <span class="badge badge-success">{{ score }}%</span>
                        {% elif score >= 60 %}
                        <span class="badge badge-warning">{{ score }}%</span>
                        {% else %}
                        <span class="badge badge-danger">{{ score }}%</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="2" style="text-align: center; color: var(--text-muted);">Aucun score détaillé disponible</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<div class="admin-card">
    <h3>Réponses détaillées</h3>
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        {% for answer in quiz.answers %}
        <div style="background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
            <div style="margin-bottom: 0.5rem;"><strong>Question {{ loop.index }}:</strong> {{ answer.question }}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Réponse:</strong> {{ answer.answer }}</div>
            <div>
                {% if answer.correct %}
                <span class="badge badge-success">Correct</span>
                {% else %}
                <span class="badge badge-danger">Incorrect</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% if quiz.hibp_summary %}
<div class="admin-card">
    <h3>Résumé HIBP (Have I Been Pwned)</h3>
    <div style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
        {% if quiz.hibp_summary is mapping and 'breach_count' in quiz.hibp_summary %}
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-primary);">Nombre de fuites détectées:</strong>
                <span style="color: {% if quiz.hibp_summary['breach_count'] > 0 %}#ef4444{% else %}#10b981{% endif %}; font-size: 1.2rem; font-weight: bold; margin-left: 0.5rem;">
                    {{ quiz.hibp_summary['breach_count'] }}
                </span>
            </div>
            
            {% if quiz.hibp_summary['breach_count'] > 0 and quiz.hibp_summary.get('breaches') %}
                <div style="margin-top: 1.5rem;">
                    <strong style="color: var(--text-primary); display: block; margin-bottom: 1rem;">Fuites identifiées:</strong>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        {% for breach in quiz.hibp_summary['breaches'][:5] %}
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 6px; border-left: 3px solid #ef4444;">
                            <div style="font-weight: bold; color: var(--text-primary); margin-bottom: 0.5rem;">{{ breach.get('Name', 'Inconnu') }}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                {% if breach.get('BreachDate') %}
                                <div><strong>Date:</strong> {{ breach['BreachDate'] }}</div>
                                {% endif %}
                                {% if breach.get('DataClasses') %}
                                <div style="margin-top: 0.5rem;"><strong>Données compromises:</strong> {{ breach['DataClasses']|join(', ') }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        {% if quiz.hibp_summary['breaches']|length > 5 %}
                        <div style="color: var(--text-muted); font-style: italic; text-align: center;">
                            ... et {{ quiz.hibp_summary['breaches']|length - 5 }} autre(s) fuite(s)
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% elif quiz.hibp_summary['breach_count'] == 0 %}
                <div style="color: #10b981; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 6px; margin-top: 1rem;">
                    ✓ Aucune fuite de données détectée pour cet email
                </div>
            {% endif %}
        {% else %}
            <div style="color: var(--text-secondary);">
                <pre style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.85rem;">{{ quiz.hibp_summary|tojson(indent=2) }}</pre>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}

<div style="margin-top: 2rem;">
    <a href="{{ url_for('admin_panel.quiz_history') }}" class="btn btn-secondary">Retour à l'historique</a>
</div>
{% endblock %}
