<!--
  CyberConfiance
  By MOA Digital Agency LLC
  Developed by: Aisance KALONJI
  Contact: moa@myoneart.com
  www.myoneart.com
-->
{% extends "admin/base.html" %}

{% block title %}Messages de contact - Administration{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Messages de contact</h1>
    <p>Liste des messages reçus via le formulaire de contact</p>
</div>

<div class="admin-toolbar">
    <div class="toolbar-left">
        <div class="filter-group">
            <label for="status-filter">Statut:</label>
            <select id="status-filter" onchange="window.location.href='?status=' + this.value">
                <option value="">Tous les messages</option>
                <option value="new" {% if status == 'new' %}selected{% endif %}>Nouveaux</option>
                <option value="read" {% if status == 'read' %}selected{% endif %}>Lus</option>
                <option value="replied" {% if status == 'replied' %}selected{% endif %}>Répondus</option>
                <option value="archived" {% if status == 'archived' %}selected{% endif %}>Archivés</option>
            </select>
        </div>
        <div class="filter-group">
            <input type="text" id="search-input" placeholder="Rechercher..." style="min-width: 250px;">
        </div>
    </div>
    <div class="toolbar-right">
        <button onclick="replySelected()" class="btn btn-secondary btn-sm" id="reply-btn" style="display: none;">Répondre à la sélection</button>
        <button onclick="document.getElementById('compose-modal').style.display='block'" class="btn btn-primary">+ Nouveau message</button>
    </div>
</div>

<div id="compose-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; padding:2rem; overflow-y: auto;">
    <div style="background: rgba(10, 22, 40, 0.95); backdrop-filter: blur(60px); max-width: 700px; margin: 2rem auto; padding: 2.5rem; border-radius: 16px; border: 1px solid rgba(59, 130, 246, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
        <h3 style="color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1.5rem;">Composer un message</h3>
        <form method="POST" action="{{ url_for('admin_panel.send_contact_message') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div style="margin-bottom: 1.25rem;">
                <label style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-weight: 500;">Destinataires:</label>
                <input type="text" name="recipients" placeholder="email1@example.com, email2@example.com" required style="width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem;">
            </div>
            <div style="margin-bottom: 1.25rem;">
                <label style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-weight: 500;">Sujet:</label>
                <input type="text" name="subject" required style="width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem;">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-weight: 500;">Message:</label>
                <textarea name="message" rows="10" required style="width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; color: var(--text-primary); resize: vertical; font-size: 0.95rem; font-family: inherit;"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="document.getElementById('compose-modal').style.display='none'" class="btn btn-secondary">Annuler</button>
                <button type="submit" class="btn btn-success">Envoyer le message</button>
            </div>
        </form>
    </div>
</div>

<div class="admin-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0;">Messages ({{ contacts.total }})</h3>
        <div style="color: var(--text-secondary); font-size: 0.9rem;">
            <span id="selected-count" style="display: none;">
                <strong id="count-text">0</strong> sélectionné(s)
            </span>
        </div>
    </div>
    
    <div class="table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="select-all" onclick="toggleAll(this)">
                    </th>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Sujet</th>
                    <th style="min-width: 200px;">Message</th>
                    <th style="width: 140px;">Date</th>
                    <th style="width: 100px;">Statut</th>
                    <th class="actions-cell" style="width: 200px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for contact in contacts.items %}
                <tr>
                    <td>
                        <input type="checkbox" class="contact-checkbox" data-email="{{ contact.email }}" onchange="updateReplyBtn()">
                    </td>
                    <td><strong style="color: var(--text-primary);">{{ contact.name }}</strong></td>
                    <td style="font-family: monospace; font-size: 0.85rem;">{{ contact.email }}</td>
                    <td>{{ contact.subject }}</td>
                    <td>
                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ contact.message }}
                        </div>
                    </td>
                    <td style="font-size: 0.85rem;">{{ contact.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                        {% if contact.status == 'new' %}
                        <span class="badge badge-warning">Nouveau</span>
                        {% elif contact.status == 'read' %}
                        <span class="badge badge-info">Lu</span>
                        {% elif contact.status == 'replied' %}
                        <span class="badge badge-success">Répondu</span>
                        {% elif contact.status == 'archived' %}
                        <span class="badge badge-secondary">Archivé</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ contact.status }}</span>
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <div class="action-btn-group">
                            <a href="{{ url_for('admin_panel.contact_detail', contact_id=contact.id) }}" class="btn btn-secondary btn-sm" title="Voir">Voir</a>
                            <button onclick="replyToContact('{{ contact.email }}')" class="btn btn-primary btn-sm" title="Répondre">Répondre</button>
                            <form method="POST" action="{{ url_for('admin_panel.delete_contact', contact_id=contact.id) }}" style="display: inline;" onsubmit="return confirm('Supprimer ce message ?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-danger btn-sm" title="Supprimer">✕</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if contacts.pages > 1 %}
    <div class="pagination">
        {% if contacts.has_prev %}
        <a href="?page={{ contacts.prev_num }}{% if status %}&status={{ status }}{% endif %}">‹ Précédent</a>
        {% endif %}
        
        {% for page_num in contacts.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
                {% if page_num == contacts.page %}
                    <span class="active">{{ page_num }}</span>
                {% else %}
                    <a href="?page={{ page_num }}{% if status %}&status={{ status }}{% endif %}">{{ page_num }}</a>
                {% endif %}
            {% else %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if contacts.has_next %}
        <a href="?page={{ contacts.next_num }}{% if status %}&status={{ status }}{% endif %}">Suivant ›</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function toggleAll(checkbox) {
    const checkboxes = document.querySelectorAll('.contact-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateReplyBtn();
}

function updateReplyBtn() {
    const checked = document.querySelectorAll('.contact-checkbox:checked');
    const replyBtn = document.getElementById('reply-btn');
    const selectedCount = document.getElementById('selected-count');
    const countText = document.getElementById('count-text');
    
    if (checked.length > 0) {
        replyBtn.style.display = 'inline-flex';
        selectedCount.style.display = 'inline';
        countText.textContent = checked.length;
    } else {
        replyBtn.style.display = 'none';
        selectedCount.style.display = 'none';
    }
}

function replySelected() {
    const checked = document.querySelectorAll('.contact-checkbox:checked');
    const emails = Array.from(checked).map(cb => cb.dataset.email).join(', ');
    const modal = document.getElementById('compose-modal');
    const recipientsInput = modal.querySelector('input[name="recipients"]');
    recipientsInput.value = emails;
    modal.style.display = 'block';
}

function replyToContact(email) {
    const modal = document.getElementById('compose-modal');
    const recipientsInput = modal.querySelector('input[name="recipients"]');
    recipientsInput.value = email;
    modal.style.display = 'block';
}

// Search functionality
document.getElementById('search-input').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.admin-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %}
